box:
  id: ruby:alpine
  ports:
    - "4567"
services:
  - id: mysql:latest
    env:
      MYSQL_ROOT_PASSWORD: $MYSQL_ROOT_PASSWORD
      MYSQL_USER: $MYSQL_USER
      MYSQL_PASSWORD: $MYSQL_PASSWORD
      MYSQL_DATABASE: $MYSQL_DATABASE
    cmd: --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --default_authentication_plugin=mysql_native_password
dev:
  steps:
    - script:
        name: apk
        code: |
          apk update
          apk add --no-cache g++ gcc libxml2-dev libxslt-dev make
    - bundle-install
    - internal/watch:
        code: |
          export DB_USER=$MYSQL_USER
          export DB_PASSWORD=$MYSQL_PASSWORD
          export DB_HOST=$MYSQL_PORT_3306_TCP_ADDR
          export DB_PORT=$MYSQL_PORT_3306_TCP_PORT
          export DB_DATABASE=$MYSQL_DATABASE
          bundle exec ruby app.rb
        reload: true
build:
  steps:
    - script:
        name: apk
        code: |
          apk update
          apk add --no-cache g++ gcc libxml2-dev libxslt-dev make
    - bundle-install
rubocop:
  steps:
    - script:
        name: RuboCop
        code: bundle exec rubocop -L
rspec:
  steps:
    - script:
        name: rspec
        code: |
          export DB_USER=$MYSQL_USER
          export DB_PASSWORD=$MYSQL_PASSWORD
          export DB_HOST=$MYSQL_PORT_3306_TCP_ADDR
          export DB_PORT=$MYSQL_PORT_3306_TCP_PORT
          export DB_DATABASE=$MYSQL_DATABASE
          echo "DB_USER=$DB_USER"
          bundle exec rspec -O /dev/null -fd
    # - script:
    #     name: Pause
    #     code: sleep 600
